#!/usr/bin/env sh

echo "ğŸ” Running pre-commit validation..."

# Run lint-staged for file formatting and linting
npx lint-staged

# Exit if lint-staged fails
if [ $? -ne 0 ]; then
  echo "âŒ Lint-staged checks failed!"
  exit 1
fi

# Run comprehensive validation
echo "ğŸ§ª Running comprehensive validation..."

# Validate Bicep templates
if [ -f "infra/main.bicep" ]; then
  echo "ğŸ“ Validating Bicep template..."
  az bicep build --file infra/main.bicep --stdout > /dev/null
  if [ $? -ne 0 ]; then
    echo "âŒ Bicep template validation failed!"
    exit 1
  fi
  echo "âœ… Bicep template validation passed"
fi

# Run our custom lint script
if [ -f "scripts/lint.ps1" ]; then
  echo "ğŸ” Running PowerShell linting..."
  pwsh -ExecutionPolicy Bypass -File scripts/lint.ps1 -CI
  if [ $? -ne 0 ]; then
    echo "âŒ PowerShell linting failed!"
    exit 1
  fi
  echo "âœ… PowerShell linting passed"
elif [ -f "scripts/lint.sh" ]; then
  echo "ğŸ” Running Bash linting..."
  bash scripts/lint.sh --ci
  if [ $? -ne 0 ]; then
    echo "âŒ Bash linting failed!"
    exit 1
  fi
  echo "âœ… Bash linting passed"
fi

echo "âœ… All pre-commit checks passed!"
exit 0
